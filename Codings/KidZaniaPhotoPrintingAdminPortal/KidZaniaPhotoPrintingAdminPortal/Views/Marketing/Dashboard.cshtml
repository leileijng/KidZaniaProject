@{
    Layout = "~/Views/Shared/Menu.cshtml";
}
<!-- slimscroll js-->
<script src="~/assets/vendor/slimscroll/jquery.slimscroll.js"></script>
<!-- chartjs js-->
<script src="~/assets/vendor/charts/charts-bundle/Chart.bundle.js"></script>
<script src="~/assets/vendor/charts/charts-bundle/chartjs.js"></script>

<!-- main js-->
<script src="~/assets/libs/js/main-js.js"></script>
<!-- jvactormap js-->
<script src="~/assets/vendor/jvectormap/jquery-jvectormap-2.0.2.min.js"></script>
<script src="~/assets/vendor/jvectormap/jquery-jvectormap-world-mill-en.js"></script>
<!-- sparkline js-->
<script src="~/assets/vendor/charts/sparkline/jquery.sparkline.js"></script>
<script src="~/assets/vendor/charts/sparkline/spark-js.js"></script>
<!-- dashboard sales js-->
<script src="~/assets/libs/js/dashboard-sales.js"></script>

<div class="container-fluid  dashboard-content">
    <!-- ============================================================== -->
    <!-- pagehader  -->
    <!-- ============================================================== -->
    <div class="row">
        <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
            <div class="page-header">
                <h3 class="mb-2">Sales Dashboard </h3>
            </div>
        </div>
    </div>
    <!-- ============================================================== -->
    <!-- pagehader  -->
    <!-- ============================================================== -->
    <div class="row">
        <!-- metric -->
        <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="text-muted">Order</h5>
                    <div class="metric-value d-inline-block">
                        <h1 class="mb-1 text-primary" id="NumberOfOrder">32,100 </h1>
                    </div>
                    <div class="metric-label d-inline-block float-right text-success" id="ColorOfOrder">
                        <i class="fa fa-fw fa-caret-up" id="IconOfOrder"></i><span id="RateOfOrder">5.27%</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- /. metric -->
        <!-- metric -->
        <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="text-muted">Revenue</h5>
                    <div class="metric-value d-inline-block">
                        <h1 class="mb-1 text-primary" id="numberOfRevenue">$5,656</h1>
                    </div>
                    <div class="metric-label d-inline-block float-right text-danger" id="ColorOfRevenue">
                        <i class="fa fa-fw fa-caret-down" id="IconOfRevenue"></i><span id="RateOfRevenue">1.08%</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- /. metric -->
        <!-- metric -->
        <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="text-muted">Printed Photos</h5>
                    <div class="metric-value d-inline-block">
                        <h1 class="mb-1 text-primary" id="numberOfPhotos">22</h1>
                    </div>
                    <div class="metric-label d-inline-block float-right text-success" id="ColorOfPhotos">
                        <i class="fa fa-fw fa-caret-up" id="IconOfPhotos"></i><span id="rateOfPhotos">4.87%</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- /. metric -->
        <!-- metric -->
        <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="text-muted" id="numberOfPO">Waiting Orders</h5>
                    <div class="metric-value d-inline-block">
                        <h1 class="mb-1 text-primary">12</h1>
                    </div>
                </div>
            </div>
        </div>
        <!-- /. metric -->
    </div>
    <!-- ============================================================== -->
    <!-- revenue  -->
    <!-- ============================================================== -->
    <div class="row">
        <div class=" col-lg-12 col-sm-12 col-12">
            <div class="card">
                <h5 class="card-header">Revenue</h5>
                <div class="card-body">
                    <div id="lineChart"></div>
                </div>
                <div class="card-body border-top">
                    <div class="row">
                        <div class="offset-xl-1 col-xl-3 col-lg-3 col-md-12 col-sm-12 col-12 p-3 pr-5 mr-5">
                            <h4 style="font-size:0.9rem">Average Completed Orders / Hour:</h4>
                            <p>
                                Today's Peak Period: <span id="peakToday"></span>
                            </p>
                        </div>
                        <div class="offset-xl-1 col-xl-3 col-lg-3 col-md-6 col-sm-12 col-12 p-3 pl-5 ml-4">
                            <h2 class="font-weight-normal mb-3"><span id="avgToday"></span></h2>
                            <div class="mb-0 mt-3 legend-item">
                                <span class="fa-xs text-primary mr-1 legend-title "><i class="fa fa-fw fa-square-full"></i></span>
                                <span class="legend-text">Today</span>
                            </div>
                        </div>
                        <div class="offset-xl-1 col-xl-3 col-lg-3 col-md-6 col-sm-12 col-12 p-3 pl-0 ml-0">
                            <h2 class="font-weight-normal mb-3">
                                <span id="avgYesterday"></span>
                            </h2>
                            <div class="text-muted mb-0 mt-3 legend-item"> 
                            <span class="fa-xs text-secondary mr-1 legend-title">
                                <i class="fa fa-fw fa-square-full"></i>
                                </span>
                            <span class="legend-text">Yesterday</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ============================================================== -->
        <!-- end reveune  -->
        <!-- ============================================================== -->
        <!-- ============================================================== -->
        <!-- total sale  -->
        <!-- ============================================================== -->
        
        <!-- ============================================================== -->
        <!-- end total sale  -->
        <!-- ============================================================== -->
    </div>
    <div class="row">
        <!-- ============================================================== -->
        <!-- top selling products  -->
        <!-- ============================================================== -->
        <div class="col-xl-8 col-lg-12 col-md-12 col-sm-12 col-12">
            <div class="card">
                <h5 class="card-header">Newly Updated Orders</h5>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table">
                            <thead class="bg-light">
                                <tr class="border-0">
                                    <th class="border-0">Order Number</th>
                                    <th class="border-0">Products</th>
                                    <th class="border-0">Photo Quantity</th>
                                    <th class="border-0">Order Status</th>
                                    <th class="border-0">Total Amount</th>
                                    <th class="border-0">Updated Time</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTable">
                                
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- ============================================================== -->
        <!-- end top selling products  -->
        <!-- ============================================================== -->
        <!-- ============================================================== -->
        <!-- revenue locations  -->
        <!-- ============================================================== -->
        <div class="col-xl-4 col-lg-12 col-md-4 col-sm-12 col-12">
            <div class="card">
                <h5 class="card-header">Top Selling Products</h5>
                <div class="card-body">
                    <div id="donutchartForProductSales"></div>
                    <div class="chart-widget-list" id="productLegend">

                    </div>
                </div>
            </div>
        </div>
        <!-- ============================================================== -->
        <!-- end revenue locations  -->
        <!-- ============================================================== -->
    </div>
</div>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script>

    $(document).ready(function () {
        $('#menuDashboard').addClass("active");
        loadRealTimeData();
        loadOrderDetailsTable();
        
        google.charts.load("current", { packages: ["corechart"] });
        google.charts.setOnLoadCallback(drawPieChart);

        google.charts.load('current', { packages: ['corechart', 'line'] });
        google.charts.setOnLoadCallback(drawLineChart);
    });

    //AJAX Call to retrieve data from backend
    function loadRealTimeData() {
        $.ajax({
            type: "GET",
            url: "/api/dashboard/retrieveRealTimeData",
            dataType: "json",
            success: function (data) {
                $('#NumberOfOrder').text(data.todayOrderNumber);
                $('#numberOfRevenue').text(`$${data.todayRevenueNumber.toFixed(2)}`);
                $('#numberOfPhotos').text(data.todayPhotoNumber);

                var orderRate = data.rateOrder;
                var revenueRate = data.rateRevenue;
                var photoRate = data.ratePhoto;

                $('#RateOfOrder').text(orderRate + "%");
                if (orderRate < 0) {
                    $('#IconOfOrder').removeClass('fa-caret-up');
                    $('#IconOfOrder').addClass('fa-caret-down');
                    $('#ColorOfOrder').removeClass('text-success');
                    $('#ColorOfOrder').addClass('text-danger');
                }
                else {
                    $('#IconOfOrder').addClass('fa-caret-up');
                    $('#IconOfOrder').removeClass('fa-caret-down');
                    $('#ColorOfOrder').addClass('text-success');
                    $('#ColorOfOrder').removeClass('text-danger');
                }

                $('#RateOfRevenue').text(revenueRate + "%");
                if (revenueRate < 0) {
                    $('#IconOfRevenue').removeClass('fa-caret-up');
                    $('#IconOfRevenue').addClass('fa-caret-down');
                    $('#ColorOfRevenue').removeClass('text-success');
                    $('#ColorOfRevenue').addClass('text-danger');
                }
                else {
                    $('#IconOfRevenue').addClass('fa-caret-up');
                    $('#IconOfRevenue').removeClass('fa-caret-down');
                    $('#ColorOfRevenue').addClass('text-success');
                    $('#ColorOfRevenue').removeClass('text-danger');
                }

                $('#rateOfPhotos').text(photoRate + "%");
                if (photoRate < 0) {
                    $('#IconOfPhotos').removeClass('fa-caret-up');
                    $('#IconOfPhotos').addClass('fa-caret-down');
                    $('#ColorOfPhotos').removeClass('text-success');
                    $('#ColorOfPhotos').addClass('text-danger');
                }
                else {
                    $('#IconOfPhotos').addClass('fa-caret-up');
                    $('#IconOfPhotos').removeClass('fa-caret-down');
                    $('#ColorOfPhotos').addClass('text-success');
                    $('#ColorOfPhotos').removeClass('text-danger');
                }
            },
            error: function (data) {
                console.log("Error");
                console.log(data);
            }
        });
    }

    function loadOrderDetailsTable() {
        $('#ordersTable').html("");
        console.log("function called");
        $.ajax({
            type: "GET",
            url: "/api/dashboard/retriveNewlyUpdatedOrders",
            dataType: "json",
            success: function (data) {
                console.log(data);
                for (var i = 0; i < data.length; i++) {
                    var $orderRow = $(`<tr>
                                    <td>${data[i].OrderCode}</td>
                                    <td>${data[i].Products}</td>
                                    <td>${data[i].NumberOfPhotos}</td>
                                    <td>${data[i].OrderStatus}</td>
                                    <td>$${data[i].TotalAmount.toFixed(2)}</td>
                                    <td>${data[i].UpdatedTime}</td>
                                </tr>`);
                    $('#ordersTable').append($orderRow);
                }
                var $refreshrRow = $(`<tr><td colspan="6"><a onclick="loadOrderDetailsTable()" class="btn btn-outline-light float-right">Refresh</a></td></tr>`);
                $('#ordersTable').append($refreshrRow);
                
            },
            error: function (data) {
                console.log("Error");
                console.log(data);
            }
        });
    }

    function drawPieChart() {
        $.ajax({
            type: "GET",
            url: "/api/dashboard/retrivePieChartData",
            dataType: "json",
            success: function (data) {
                loadPieChart(data);
            },
            error: function (data) {
                console.log("Error");
                console.log(data);
            }
        });
    }

    function loadPieChart(pieData) {
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Sales Product');
        data.addColumn('number', 'Product Revenue');
        var dataRows = [];

        var listOfColors = ['#EF9191', '#9791EF', '#ECEF91', '#91EF98', '#91ADEF', '#839573', '#41C6BF'];
        var pieColors = [];
        for (i = 0; i < pieData.length; i++) {
            dataRows.push([pieData[i].product_name, { v: pieData[i].amount, f: `$${pieData[i].amount.toFixed(2)}` }]);
            var $proLegend = $(`<p><span class="fa-xs mr-1 legend-title" style="color: ${listOfColors[i]}"><i class="fa fa-fw fa-square-full"></i></span><span class="legend-text">${pieData[i].product_name}</span><span class="float-right">$${pieData[i].amount.toFixed(2)}</span></p>`)
            $('#productLegend').append($proLegend);
            pieColors.push(listOfColors[i]);
        }
        data.addRows(dataRows);
        console.log(data);

        var options = {
            pieSliceText: 'none',
            pieHole: 0.5,
            legend: 'none',
            chartArea: {
                left: "3%",
                top: "3%",
                height: "94%",
                width: "94%"
            },
            colors: pieColors
        };

        var chart = new google.visualization.PieChart(document.getElementById('donutchartForProductSales'));
        chart.draw(data, options);
    }

    function drawLineChart() {
        $.ajax({
            type: "GET",
            url: "/api/dashboard/retriveLineChartData",
            dataType: "json",
            success: function (data) {
                var sumYest = 0;
                for (var i = 0; i < data.length; i++) {
                    sumYest += data[i].yesterdayNumberOfOrders;
                }
                var averageYest = sumYest / data.length;
                $('#avgYesterday').text(averageYest);

                if (data[0].todayNumberOfOrders == -1) {
                    $('#avgToday').text("N.A.");
                    $('#peakToday').text("N.A.");
                    loadYesterdayLineChart(data);
                } else {
                    var sumToday = 0;
                    var peakNumberOfOrders = 0;
                    var peakPeriod = "";
                    for (var i = 0; i < data.length; i++) {
                        sumToday += data[i].todayNumberOfOrders;
                        if (data[i].todayNumberOfOrders > peakNumberOfOrders) {
                            peakNumberOfOrders = data[i].todayNumberOfOrders;
                            peakPeriod = data[i].TimeSpan;
                        }
                        else if (data[i].todayNumberOfOrders == peakNumberOfOrders) {
                            peakPeriod += ", " + data[i].TimeSpan;
                        }
                    }
                    var averageToday = sumToday / data.length;
                    $('#avgToday').text(averageToday);
                    $('#peakToday').text(peakPeriod);
                    loadLineChart(data);
                }
            },
            error: function (data) {
                console.log("Error");
                console.log(data);
            }
        });
        
    }

    function loadLineChart(chartData) {
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Time Span');
        data.addColumn('number', 'Number Of Yesterday Orders');
        data.addColumn('number', 'Number Of Today Orders');
        data.addColumn('number', 'Number Of Today Orders');
        var dataRows = [];
        
        for (i = 0; i < chartData.length; i++) {
            dataRows.push([chartData[i].TimeSpan, chartData[i].yesterdayNumberOfOrders, chartData[i].todayNumberOfOrders, chartData[i].todayNumberOfOrders]);
        }
        data.addRows(dataRows);

        var options = {
            vAxis: { title: 'Number of Orders Completed' },
            hAxis: { title: 'Time' },
            seriesType: 'bars',
            legend: 'none',
            series: { 1 : { type: 'line' } }
        };

        var chart = new google.visualization.ComboChart(document.getElementById('lineChart'));
        chart.draw(data, options);
    }
    
    function loadYesterdayLineChart(chartData) {
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Time Span');
        data.addColumn('number', 'Number Of Yesterday Orders');
        data.addColumn('number', 'Number Of Yesterday Orders');
        var dataRows = [];

        for (i = 0; i < chartData.length; i++) {
            dataRows.push([chartData[i].TimeSpan, chartData[i].yesterdayNumberOfOrders, chartData[i].yesterdayNumberOfOrders]);
        }
        data.addRows(dataRows);

        var options = {
            vAxis: { title: 'Number of Orders Completed' },
            hAxis: { title: 'Time' },
            seriesType: 'bars',
            legend: 'none',
            series: { 1: { type: 'line' } }
        };

        var chart = new google.visualization.ComboChart(document.getElementById('lineChart'));
        chart.draw(data, options);

    }

</script>